---
import BaseLayout from "../layouts/BaseLayout.astro";
import Navbar from "../components/Navbar.astro";
---

<BaseLayout
  title="Handyman Services in West Fort Worth"
  description="Affordable and reliable handyman services in West Fort Worth. Drywall repair, door repair, fixture installation, and home maintenance."
>
  <Navbar />

  <section class="pt-40 pb-24 bg-brand-offwhite">
    <div class="max-w-3xl mx-auto px-6">
      <h1 class="text-4xl font-bold text-brand-navy mb-6 text-center">
        Request an Estimate
      </h1>

      <p class="text-center text-brand-gray mb-10">
        Tell us about your project and we'll get back to you.
      </p>

      <form id="contactForm" class="space-y-6 bg-white p-8 rounded-xl shadow">
        <!-- Honeypot spam field -->
        <input
          name="project_budget_reference_id"
          type="text"
          autocomplete="off"
          tabindex="-1"
          class="hidden"
        />
        <input
          name="name"
          placeholder="Name"
          required
          class="w-full border p-4 rounded"
        />

        <input
          name="email"
          type="email"
          placeholder="Email"
          required
          class="w-full border p-4 rounded"
        />

        <input
          name="phone"
          placeholder="Phone"
          class="w-full border p-4 rounded"
        />

        <textarea
          name="message"
          placeholder="Describe your project"
          required
          rows="5"
          class="w-full border p-4 rounded"></textarea>

        <div>
          <label class="block mb-2 font-semibold">
            Upload Photos (optional)
          </label>

          <input
            type="file"
            id="photoUpload"
            multiple
            accept="image/*"
            class="w-full border p-3 rounded"
          />

          <div id="uploadStatus" class="text-sm mt-2 text-gray-500"></div>

          <!-- Hidden field to store uploaded URLs -->
          <input type="hidden" name="photoUrls" id="photoUrls" />

          <p class="text-sm text-gray-500 mt-1">
            You can upload multiple photos.
          </p>
        </div>
      </form>

      <button
        class="w-full bg-brand-red text-white py-4 rounded-lg font-semibold"
      >
        Send Request
      </button>

      <p id="formStatus" class="text-center"></p>
    </div>
  </section>
</BaseLayout>

<script>
  const form = document.getElementById("contactForm");
  const status = document.getElementById("formStatus");
  const uploadInput = document.getElementById("photoUpload");
  const uploadStatus = document.getElementById("uploadStatus");
  const photoUrlsField = document.getElementById("photoUrls");

  const CLOUD_NAME = "dg7cstdp2";
  const UPLOAD_PRESET = "handyman_uploads";

  async function uploadImages(files) {
    if (!files.length) return [];

    uploadStatus.textContent = "Uploading photos...";

    const uploads = [...files].map(async (file) => {
      const data = new FormData();
      data.append("file", file);
      data.append("upload_preset", UPLOAD_PRESET);

      const res = await fetch(
        `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`,
        {
          method: "POST",
          body: data,
        },
      );

      const json = await res.json();
      return json.secure_url;
    });

    const urls = await Promise.all(uploads);
    uploadStatus.textContent = "Photos uploaded âœ“";
    return urls;
  }

  form?.addEventListener("submit", async (e) => {
    e.preventDefault();

    status.textContent = "Sending...";

    let photoUrls = [];

    if (uploadInput.files.length) {
      photoUrls = await uploadImages(uploadInput.files);
      photoUrlsField.value = JSON.stringify(photoUrls);
    }

    const formData = new FormData(form);

    const res = await fetch("/api/contact", {
      method: "POST",
      body: formData,
    });

    if (res.ok) {
      status.textContent = "Thanks! We'll contact you soon.";
      form.reset();
      uploadStatus.textContent = "";
    } else {
      status.textContent = "Something went wrong.";
    }
  });
</script>
